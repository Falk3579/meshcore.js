<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>MeshCore</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>
<body class="bg-slate-300">

<div id="app" class="space-y-2 p-3">

    <!-- header -->
    <div class="flex border bg-gray-50 p-3 rounded shadow">
        <div class="my-auto">
            <div class="font-bold">MeshCore Client</div>
            <div class="text-sm">Developed by <a target="_blank" href="https://liamcottle.com" class="text-blue-500 hover:underline">Liam Cottle</a></div>
        </div>
    </div>

    <div class="border bg-gray-50 rounded shadow">

        <div class="p-3 border-t space-x-1">
            <button @click="askForSerialPort" class="border border-gray-500 px-2 bg-gray-100 hover:bg-gray-200 rounded">
                Connect
            </button>
            <button @click="disconnect" class="border border-gray-500 px-2 bg-gray-100 hover:bg-gray-200 rounded">
                Disconnect
            </button>
            <button @click="sendCommandAppStart" class="border border-gray-500 px-2 bg-gray-100 hover:bg-gray-200 rounded">
                AppStart
            </button>
            <button @click="sendSendSelfAdvert(0)" class="border border-gray-500 px-2 bg-gray-100 hover:bg-gray-200 rounded">
                SendSelfAdvert(ZeroHop)
            </button>
            <button @click="sendSendSelfAdvert(1)" class="border border-gray-500 px-2 bg-gray-100 hover:bg-gray-200 rounded">
                SendSelfAdvert(Flood)
            </button>
            <button @click="sendCommandSetAdvertName" class="border border-gray-500 px-2 bg-gray-100 hover:bg-gray-200 rounded">
                SetAdvertName
            </button>
            <button @click="sendCommandSetAdvertLatLon" class="border border-gray-500 px-2 bg-gray-100 hover:bg-gray-200 rounded">
                SetAdvertLatLon
            </button>
            <button @click="sendCommandRemoveContact" class="border border-gray-500 px-2 bg-gray-100 hover:bg-gray-200 rounded">
                RemoveContact
            </button>
            <button @click="sendCommandAddUpdateContact" class="border border-gray-500 px-2 bg-gray-100 hover:bg-gray-200 rounded">
                AddUpdateContact
            </button>
            <button @click="sendCommandSyncNextMessage" class="border border-gray-500 px-2 bg-gray-100 hover:bg-gray-200 rounded">
                SyncNextMessage
            </button>
            <button @click="sendCommandGetContacts" class="border border-gray-500 px-2 bg-gray-100 hover:bg-gray-200 rounded">
                GetContacts
            </button>
            <button @click="sendCommandGetDeviceTime" class="border border-gray-500 px-2 bg-gray-100 hover:bg-gray-200 rounded">
                GetDeviceTime
            </button>
            <button @click="sendCommandSetDeviceTime" class="border border-gray-500 px-2 bg-gray-100 hover:bg-gray-200 rounded">
                SetDeviceTime
            </button>
            <button @click="sendCommandSetRadioParams" class="border border-gray-500 px-2 bg-gray-100 hover:bg-gray-200 rounded">
                SetRadioParams
            </button>
            <button @click="sendCommandSetTxPower" class="border border-gray-500 px-2 bg-gray-100 hover:bg-gray-200 rounded">
                SetTxPower
            </button>
            <button @click="sendCommandResetPath" class="border border-gray-500 px-2 bg-gray-100 hover:bg-gray-200 rounded">
                ResetPath
            </button>
            <button @click="sendCommandSendTxtMsg" class="border border-gray-500 px-2 bg-gray-100 hover:bg-gray-200 rounded">
                SendTxtMsg
            </button>
        </div>

    </div>

</div>

<script type="module">
    import Device from "./src/device.js";
    import Constants from "./src/constants.js";
    Vue.createApp({
        data() {
            return {
                device: null,
            };
        },
        mounted() {

        },
        methods: {
            async askForSerialPort() {

                if(!navigator.serial){
                    alert("Web Serial is not supported in this browser");
                    return null;
                }

                // ask user to select device
                const serialPort = await navigator.serial.requestPort({
                    filters: [],
                });

                this.device = await Device.fromSerialPort(serialPort);

            },
            async disconnect() {
                if(this.device){
                    await this.device.close();
                    this.device = null;
                }
            },
            async sendCommandAppStart() {
                await this.device.sendCommandAppStart();
            },
            async sendCommandSendTxtMsg() {
                const txtType = Constants.TxtTypes.Plain;
                const attempt = 0;
                const senderTimestamp = Math.floor(Date.now() / 1000);
                const pubKeyPrefix = new Uint8Array([148, 63, 175, 162, 88, 212, 192, 40, 214, 185, 213, 140, 42, 145, 194, 186, 70, 71, 112, 68, 0, 192, 65, 4, 105, 143, 230, 50, 162, 79, 247, 192]);
                const text = `Test Message: ${senderTimestamp}`;
                await this.device.sendCommandSendTxtMsg(txtType, attempt, senderTimestamp, pubKeyPrefix, text);
            },
            async sendSendSelfAdvert(type) {
                await this.device.sendCommandSendSelfAdvert(type);
            },
            async sendCommandGetContacts() {
                await this.device.sendCommandGetContacts();
            },
            async sendCommandGetDeviceTime() {
                await this.device.sendCommandGetDeviceTime();
            },
            async sendCommandSetDeviceTime() {
                const timestamp = Math.floor(Date.now() / 1000);
                await this.device.sendCommandSetDeviceTime(timestamp);
            },
            async sendCommandSetTxPower() {
                const txPower = 22;
                await this.device.sendCommandSetTxPower(txPower);
            },
            async sendCommandResetPath() {
                const publicKey = new Uint8Array([244, 231, 60, 250, 245, 218, 131, 156, 156, 98, 130, 39, 222, 43, 123, 147, 98, 200, 218, 251, 242, 89, 111, 108, 25, 191, 127, 151, 222, 192, 233, 177]);
                await this.device.sendCommandResetPath(publicKey);
            },
            async sendCommandSetRadioParams() {
                const radioFreq = 917375;
                const radioBw = 250000;
                const radioSf = 7;
                const radioCr = 5;
                await this.device.sendCommandSetRadioParams(radioFreq, radioBw, radioSf, radioCr);
            },
            async sendCommandSetAdvertName() {

                // ask user for name
                const name = prompt("Please enter name");
                if(!name){
                    return;
                }

                // set name
                await this.device.sendCommandSetAdvertName(name);

            },
            async sendCommandSetAdvertLatLon() {
                const lat = 123;
                const lon = 456;
                await this.device.sendCommandSetAdvertLatLon(lat, lon);
            },
            async sendCommandRemoveContact() {
                const publicKey = new Uint8Array([148, 63, 175, 162, 88, 212, 192, 40, 214, 185, 213, 140, 42, 145, 194, 186, 70, 71, 112, 68, 0, 192, 65, 4, 105, 143, 230, 50, 162, 79, 247, 192]);
                await this.device.sendCommandRemoveContact(publicKey);
            },
            async sendCommandAddUpdateContact() {
                const publicKey = new Uint8Array([148, 63, 175, 162, 88, 212, 192, 40, 214, 185, 213, 140, 42, 145, 194, 186, 70, 71, 112, 68, 0, 192, 65, 4, 105, 143, 230, 50, 162, 79, 247, 192]);
                const type = Constants.AdvType.Chat;
                const flags = 0;
                const outPathLen = 0;
                const outPath = new Uint8Array([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]);
                const advName = "Boaty";
                const lastAdvert = 1739244825;
                const advLat = 0;
                const advLon = 0;
                await this.device.sendCommandAddUpdateContact(publicKey, type, flags, outPathLen, outPath, advName, lastAdvert, advLat, advLon);
            },
            async sendCommandSyncNextMessage() {
                await this.device.sendCommandSyncNextMessage();
            },
        },
    }).mount('#app');
</script>

</body>
</html>