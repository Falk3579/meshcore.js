<!DOCTYPE html>
<html lang="en">
<head>

    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>MeshCore</title>

    <style>
        [v-cloak] {
            display: none;
        }
    </style>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

</head>
<body class="bg-slate-300">

<div id="app" class="space-y-2 p-3" v-cloak>

    <!-- header -->
    <div class="flex border bg-gray-50 p-3 rounded shadow">
        <div class="my-auto">
            <div class="font-bold">MeshCore Connection</div>
            <div class="text-sm">Developed by <a target="_blank" href="https://liamcottle.com" class="text-blue-500 hover:underline">Liam Cottle</a></div>
        </div>
    </div>

    <!-- connection state -->
    <div class="border bg-gray-50 rounded shadow">
        <div class="p-3 space-x-1">
            <button v-if="!connection" @click="askForSerialPort" class="border border-gray-500 px-2 bg-gray-100 hover:bg-gray-200 rounded">
                Connect (Serial)
            </button>
            <button v-if="!connection" @click="askForBleDevice" class="border border-gray-500 px-2 bg-gray-100 hover:bg-gray-200 rounded">
                Connect (BLE)
            </button>
            <button v-if="connection" @click="disconnect" class="border border-gray-500 px-2 bg-gray-100 hover:bg-gray-200 rounded">
                Disconnect
            </button>
        </div>
    </div>

    <div v-if="connection" class="space-y-2">

        <!-- self info -->
        <div v-if="selfInfo" class="border bg-gray-50 rounded shadow">
            <div class="p-3">
                <div>Connected to: {{ selfInfo.name }}</div>
            </div>
        </div>

        <!-- actions -->
        <div class="border bg-gray-50 rounded shadow">
            <div class="p-3 space-x-1">
                <button @click="sendCommandAppStart" class="border border-gray-500 px-2 bg-gray-100 hover:bg-gray-200 rounded">
                    AppStart
                </button>
                <button @click="sendSendSelfAdvert(0)" class="border border-gray-500 px-2 bg-gray-100 hover:bg-gray-200 rounded">
                    SendSelfAdvert(ZeroHop)
                </button>
                <button @click="sendSendSelfAdvert(1)" class="border border-gray-500 px-2 bg-gray-100 hover:bg-gray-200 rounded">
                    SendSelfAdvert(Flood)
                </button>
                <button @click="sendCommandSetAdvertName" class="border border-gray-500 px-2 bg-gray-100 hover:bg-gray-200 rounded">
                    SetAdvertName
                </button>
                <button @click="sendCommandSetAdvertLatLon" class="border border-gray-500 px-2 bg-gray-100 hover:bg-gray-200 rounded">
                    SetAdvertLatLon
                </button>
                <button @click="sendCommandRemoveContact" class="border border-gray-500 px-2 bg-gray-100 hover:bg-gray-200 rounded">
                    RemoveContact
                </button>
                <button @click="sendCommandAddUpdateContact" class="border border-gray-500 px-2 bg-gray-100 hover:bg-gray-200 rounded">
                    AddUpdateContact
                </button>
                <button @click="sendCommandSyncNextMessage" class="border border-gray-500 px-2 bg-gray-100 hover:bg-gray-200 rounded">
                    SyncNextMessage
                </button>
                <button @click="sendCommandGetContacts" class="border border-gray-500 px-2 bg-gray-100 hover:bg-gray-200 rounded">
                    GetContacts
                </button>
                <button @click="sendCommandGetDeviceTime" class="border border-gray-500 px-2 bg-gray-100 hover:bg-gray-200 rounded">
                    GetDeviceTime
                </button>
                <button @click="sendCommandSetDeviceTime" class="border border-gray-500 px-2 bg-gray-100 hover:bg-gray-200 rounded">
                    SetDeviceTime
                </button>
                <button @click="sendCommandSetRadioParams" class="border border-gray-500 px-2 bg-gray-100 hover:bg-gray-200 rounded">
                    SetRadioParams
                </button>
                <button @click="sendCommandSetTxPower" class="border border-gray-500 px-2 bg-gray-100 hover:bg-gray-200 rounded">
                    SetTxPower
                </button>
                <button @click="sendCommandResetPath" class="border border-gray-500 px-2 bg-gray-100 hover:bg-gray-200 rounded">
                    ResetPath
                </button>
                <button @click="sendCommandSendTxtMsg" class="border border-gray-500 px-2 bg-gray-100 hover:bg-gray-200 rounded">
                    SendTxtMsg
                </button>
            </div>
        </div>

        <!-- contacts -->
        <div class="border bg-gray-50 rounded shadow">
            <div class="divide-y">
                <div v-for="contact of contacts" class="flex px-2 py-1">
                    <div class="my-auto mr-auto">
                        <div class="font-semibold">{{ contact.advName }}</div>
                        <div class="text-sm text-gray-500">Type: {{ contactTypeToString(contact.type) }} â€¢ Last Advert: {{ contact.lastAdvert }}</div>
                    </div>
                    <div class="my-auto mx-2">
                        <div @click="removeContact(contact)" class="hover:underline">Forget</div>
                    </div>
                </div>
            </div>
        </div>

    </div>

</div>

<script type="module">
    import Constants from "./src/constants.js";
    import SerialConnection from "./src/connection/serial_connection.js";
    import BleConnection from "./src/connection/ble_connection.js";
    Vue.createApp({
        data() {
            return {
                connection: null,
                selfInfo: null,
                contacts: [],
            };
        },
        mounted() {

        },
        methods: {
            async askForSerialPort() {
                this.connection = await SerialConnection.open();
                this.connection.on("connected", () => this.onConnected());
                this.connection.on("disconnected", () => this.onDisconnected());
                // this.connection.on("tx", (data) => console.log("tx", data));
                // this.connection.on("rx", (data) => console.log("rx", data));
            },
            async askForBleDevice() {
                this.connection = await BleConnection.open();
                this.connection.on("connected", () => this.onConnected());
                this.connection.on("disconnected", () => this.onDisconnected());
                // this.connection.on("tx", (data) => console.log("tx", data));
                // this.connection.on("rx", (data) => console.log("rx", data));
            },
            async disconnect() {
                if(this.connection){
                    await this.connection.close();
                    this.onDisconnected();
                    this.connection = null;
                }
            },
            async onConnected() {
                console.log("connected");
                await this.loadSelfInfo();
                await this.loadContacts();
                this.connection.on(Constants.PushCodes.Advert, async () => {
                    console.log("on advert");
                    await this.loadContacts();
                });
            },
            onDisconnected() {
                console.log("disconnected");
                this.connection = null;
            },
            async loadSelfInfo() {
                this.selfInfo = await this.connection.getSelfInfo();
            },
            async loadContacts() {
                this.contacts = await this.connection.getContacts();
            },
            contactTypeToString(type) {
                switch(type){
                    case 0: return "Unknown";
                    case 1: return "Chat";
                    case 2: return "Repeater";
                    case 3: return "Room";
                }
            },
            async sendCommandAppStart() {
                const selfInfo = await this.connection.getSelfInfo();
                console.log(selfInfo);
            },
            async sendCommandSendTxtMsg() {
                const txtType = Constants.TxtTypes.Plain;
                const attempt = 0;
                const senderTimestamp = Math.floor(Date.now() / 1000);
                const pubKeyPrefix = new Uint8Array([148, 63, 175, 162, 88, 212, 192, 40, 214, 185, 213, 140, 42, 145, 194, 186, 70, 71, 112, 68, 0, 192, 65, 4, 105, 143, 230, 50, 162, 79, 247, 192]);
                const text = `Test Message: ${senderTimestamp}`;
                await this.connection.sendCommandSendTxtMsg(txtType, attempt, senderTimestamp, pubKeyPrefix, text);
            },
            async sendSendSelfAdvert(type) {
                await this.connection.sendCommandSendSelfAdvert(type);
            },
            async sendCommandGetContacts() {
                this.contacts = await this.connection.getContacts();
                console.log(this.contacts);
            },
            async sendCommandGetDeviceTime() {
                await this.connection.sendCommandGetDeviceTime();
            },
            async sendCommandSetDeviceTime() {
                const timestamp = Math.floor(Date.now() / 1000);
                await this.connection.sendCommandSetDeviceTime(timestamp);
            },
            async sendCommandSetTxPower() {
                const txPower = 22;
                await this.connection.sendCommandSetTxPower(txPower);
            },
            async sendCommandResetPath() {
                const publicKey = new Uint8Array([244, 231, 60, 250, 245, 218, 131, 156, 156, 98, 130, 39, 222, 43, 123, 147, 98, 200, 218, 251, 242, 89, 111, 108, 25, 191, 127, 151, 222, 192, 233, 177]);
                await this.connection.sendCommandResetPath(publicKey);
            },
            async sendCommandSetRadioParams() {
                const radioFreq = 917375;
                const radioBw = 250000;
                const radioSf = 7;
                const radioCr = 5;
                await this.connection.sendCommandSetRadioParams(radioFreq, radioBw, radioSf, radioCr);
            },
            async sendCommandSetAdvertName() {

                // ask user for name
                const name = prompt("Please enter name");
                if(!name){
                    return;
                }

                // set name
                await this.connection.sendCommandSetAdvertName(name);

            },
            async sendCommandSetAdvertLatLon() {
                const lat = Math.floor(-38.661727955271765 * 1000000);
                const lon = Math.floor(178.0236810462527 * 1000000);
                console.log(lat, lon);
                await this.connection.sendCommandSetAdvertLatLon(lat, lon);
            },
            async sendCommandRemoveContact() {
                const publicKey = new Uint8Array([148, 63, 175, 162, 88, 212, 192, 40, 214, 185, 213, 140, 42, 145, 194, 186, 70, 71, 112, 68, 0, 192, 65, 4, 105, 143, 230, 50, 162, 79, 247, 192]);
                await this.connection.sendCommandRemoveContact(publicKey);
            },
            async sendCommandAddUpdateContact() {
                const publicKey = new Uint8Array([148, 63, 175, 162, 88, 212, 192, 40, 214, 185, 213, 140, 42, 145, 194, 186, 70, 71, 112, 68, 0, 192, 65, 4, 105, 143, 230, 50, 162, 79, 247, 192]);
                const type = Constants.AdvType.Chat;
                const flags = 0;
                const outPathLen = 0;
                const outPath = new Uint8Array([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]);
                const advName = "Boaty";
                const lastAdvert = 1739244825;
                const advLat = 0;
                const advLon = 0;
                await this.connection.sendCommandAddUpdateContact(publicKey, type, flags, outPathLen, outPath, advName, lastAdvert, advLat, advLon);
            },
            async sendCommandSyncNextMessage() {
                await this.connection.sendCommandSyncNextMessage();
            },
            async removeContact(contact) {

                // ask user to confirm action
                if(!confirm("Are you sure you want to remove this contact?")){
                    return;
                }

                // remove contact from device
                await this.connection.sendCommandRemoveContact(contact.publicKey);

                // reload contacts
                await this.loadContacts();

            },
        },
    }).mount('#app');
</script>

</body>
</html>